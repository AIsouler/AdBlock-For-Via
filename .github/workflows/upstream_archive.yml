name: sync_manual_commits

on:
  schedule:
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  cherry-pick-job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Your Fork
        uses: actions/checkout@v4
        with:
          ref: upstream-archive
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "History-Keeper"
          git config user.email "actions@github.com"

      - name: Fetch Upstream
        run: |
          git remote add upstream https://github.com/lingeringsound/adblock_auto.git
          git fetch upstream main

      - name: Process Commits
        run: |
          NEW_COMMITS=$(git rev-list --reverse --cherry-pick --right-only upstream-archive...upstream/main)

          for commit in $NEW_COMMITS; do
            SUBJECT=$(git log -1 --pretty=%s $commit)
            
            if [[ "$SUBJECT" == "Rules update" ]] || [[ "$SUBJECT" == "clear" ]]; then
              echo "跳过机器人提交: $SUBJECT"
              continue
            fi
            
            echo "发现新手动提交，尝试提取: $SUBJECT ($commit)"
            
            if ! git cherry-pick $commit; then
              if git status | grep -q "nothing to commit"; then
                echo "内容已存在，跳过该记录。"
                git cherry-pick --abort
              else
                echo "检测到冲突，跳过该记录。"
                git cherry-pick --abort
              fi
            fi
          done

      - name: Push to Archive Branch
        run: |
          git push origin upstream-archive
